<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasSolrSearchComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.solr.handler.component</a> &gt; <span class="el_source">MtasSolrSearchComponent.java</span></div><h1>MtasSolrSearchComponent.java</h1><pre class="source lang-java linenums">package mtas.solr.handler.component;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;

import mtas.codec.util.CodecComponent.ComponentDocument;
import mtas.codec.util.CodecComponent.ComponentFacet;
import mtas.codec.util.CodecComponent.ComponentFields;
import mtas.codec.util.CodecComponent.ComponentGroup;
import mtas.codec.MtasCodecPostingsFormat;
import mtas.codec.util.CodecComponent.ComponentCollection;
import mtas.codec.util.CodecComponent.ComponentKwic;
import mtas.codec.util.CodecComponent.ComponentList;
import mtas.codec.util.CodecComponent.ComponentPosition;
import mtas.codec.util.CodecComponent.ComponentSpan;
import mtas.codec.util.CodecComponent.ComponentTermVector;
import mtas.codec.util.CodecComponent.ComponentToken;
import mtas.codec.util.CodecUtil;
import mtas.solr.handler.component.util.MtasSolrResultMerge;
import mtas.solr.search.MtasSolrCollectionCache;
import mtas.solr.handler.component.util.MtasSolrComponentDocument;
import mtas.solr.handler.component.util.MtasSolrComponentFacet;
import mtas.solr.handler.component.util.MtasSolrComponentGroup;
import mtas.solr.handler.component.util.MtasSolrComponentCollection;
import mtas.solr.handler.component.util.MtasSolrComponentKwic;
import mtas.solr.handler.component.util.MtasSolrComponentList;
import mtas.solr.handler.component.util.MtasSolrComponentPrefix;
import mtas.solr.handler.component.util.MtasSolrComponentStats;
import mtas.solr.handler.component.util.MtasSolrComponentTermvector;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.common.util.SimpleOrderedMap;
import org.apache.solr.handler.component.ResponseBuilder;
import org.apache.solr.handler.component.SearchComponent;
import org.apache.solr.handler.component.ShardRequest;
import org.apache.solr.search.DocList;
import org.apache.solr.search.DocSet;
import org.apache.solr.search.SolrIndexSearcher;

/**
 * The Class MtasSolrSearchComponent.
 */
<span class="fc" id="L47">public class MtasSolrSearchComponent extends SearchComponent {</span>

  /** The log. */
<span class="fc" id="L50">  private static Log log = LogFactory.getLog(MtasSolrSearchComponent.class);</span>

  /** The search component. */
  MtasSolrSearchComponent searchComponent;

  /** The Constant CONFIG_COLLECTION_CACHE_DIRECTORY. */
  public static final String CONFIG_COLLECTION_CACHE_DIRECTORY = &quot;collectionCacheDirectory&quot;;

  /** The Constant CONFIG_COLLECTION_LIFETIME. */
  public static final String CONFIG_COLLECTION_LIFETIME = &quot;collectionLifetime&quot;;

  /** The Constant CONFIG_COLLECTION_MAXIMUM_NUMBER. */
  public static final String CONFIG_COLLECTION_MAXIMUM_NUMBER = &quot;collectionMaximumNumber&quot;;

  /** The Constant CONFIG_COLLECTION_MAXIMUM_OVERFLOW. */
  public static final String CONFIG_COLLECTION_MAXIMUM_OVERFLOW = &quot;collectionMaximumOverflow&quot;;

  /** The Constant PARAM_MTAS. */
  public static final String PARAM_MTAS = &quot;mtas&quot;;

  /** The Constant STAGE_TERMVECTOR_MISSING_TOP. */
<span class="fc" id="L71">  public static final int STAGE_TERMVECTOR_MISSING_TOP = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L72">      + 10;</span>

  /** The Constant STAGE_TERMVECTOR_MISSING_KEY. */
<span class="fc" id="L75">  public static final int STAGE_TERMVECTOR_MISSING_KEY = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L76">      + 11;</span>

  /** The Constant STAGE_TERMVECTOR_FINISH. */
<span class="fc" id="L79">  public static final int STAGE_TERMVECTOR_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L80">      + 12;</span>

  /** The Constant STAGE_LIST. */
<span class="fc" id="L83">  public static final int STAGE_LIST = ResponseBuilder.STAGE_EXECUTE_QUERY + 20;</span>

  /** The Constant STAGE_PREFIX. */
<span class="fc" id="L86">  public static final int STAGE_PREFIX = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L87">      + 30;</span>

  /** The Constant STAGE_STATS. */
<span class="fc" id="L90">  public static final int STAGE_STATS = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L91">      + 40;</span>

  /** The Constant STAGE_FACET. */
<span class="fc" id="L94">  public static final int STAGE_FACET = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L95">      + 50;</span>

  /** The Constant STAGE_GROUP. */
<span class="fc" id="L98">  public static final int STAGE_GROUP = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L99">      + 60;</span>

  /** The Constant STAGE_COLLECTION_INIT. */
<span class="fc" id="L102">  public static final int STAGE_COLLECTION_INIT = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L103">      + 70;</span>

  /** The Constant STAGE_COLLECTION_FINISH. */
<span class="fc" id="L106">  public static final int STAGE_COLLECTION_FINISH = ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc" id="L107">      + 71;</span>

  /** The Constant STAGE_DOCUMENT. */
<span class="fc" id="L110">  public static final int STAGE_DOCUMENT = ResponseBuilder.STAGE_GET_FIELDS</span>
<span class="fc" id="L111">      + 10;</span>

  /** The mtas solr result merge. */
  private MtasSolrResultMerge mtasSolrResultMerge;

  /** The search stats. */
  private MtasSolrComponentStats searchStats;

  /** The search termvector. */
  private MtasSolrComponentTermvector searchTermvector;

  /** The search prefix. */
  private MtasSolrComponentPrefix searchPrefix;

  /** The search facet. */
  private MtasSolrComponentFacet searchFacet;

  /** The search group. */
  private MtasSolrComponentGroup searchGroup;

  /** The search list. */
  private MtasSolrComponentList searchList;

  /** The search kwic. */
  private MtasSolrComponentKwic searchKwic;

  /** The search document. */
  private MtasSolrComponentDocument searchDocument;

  /** The search collection. */
  private MtasSolrComponentCollection searchCollection;

  /** The collection cache. */
<span class="fc" id="L144">  private MtasSolrCollectionCache collectionCache = null;</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#init(org.apache.solr.
   * common.util.NamedList)
   */
  @Override
  public void init(NamedList args) {
<span class="fc" id="L155">    super.init(args);   </span>
    // init components
<span class="fc" id="L157">    searchDocument = new MtasSolrComponentDocument(this);</span>
<span class="fc" id="L158">    searchKwic = new MtasSolrComponentKwic(this);</span>
<span class="fc" id="L159">    searchList = new MtasSolrComponentList(this);</span>
<span class="fc" id="L160">    searchGroup = new MtasSolrComponentGroup(this);</span>
<span class="fc" id="L161">    searchTermvector = new MtasSolrComponentTermvector(this);</span>
<span class="fc" id="L162">    searchPrefix = new MtasSolrComponentPrefix(this);</span>
<span class="fc" id="L163">    searchStats = new MtasSolrComponentStats(this);</span>
<span class="fc" id="L164">    searchFacet = new MtasSolrComponentFacet(this);</span>
<span class="fc" id="L165">    searchCollection = new MtasSolrComponentCollection(this);</span>
    // init collection
<span class="fc" id="L167">    String collectionCacheDirectory = null;</span>
<span class="fc" id="L168">    Long collectionLifetime = null;</span>
<span class="fc" id="L169">    Integer collectionMaximumNumber = null;</span>
<span class="fc" id="L170">    Integer collectionMaximumOverflow = null;</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">    if (args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) != null</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        &amp;&amp; args.get(CONFIG_COLLECTION_CACHE_DIRECTORY) instanceof String) {</span>
<span class="fc" id="L173">      collectionCacheDirectory = (String) args</span>
<span class="fc" id="L174">          .get(CONFIG_COLLECTION_CACHE_DIRECTORY);</span>
    }
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">    if (args.get(CONFIG_COLLECTION_LIFETIME) != null</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        &amp;&amp; args.get(CONFIG_COLLECTION_LIFETIME) instanceof Long) {</span>
<span class="fc" id="L178">      collectionLifetime = (Long) args.get(CONFIG_COLLECTION_LIFETIME);</span>
    }
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">    if (args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) != null</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        &amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_NUMBER) instanceof Integer) {</span>
<span class="fc" id="L182">      collectionMaximumNumber = (Integer) args</span>
<span class="fc" id="L183">          .get(CONFIG_COLLECTION_MAXIMUM_NUMBER);</span>
    }
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">    if (args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) != null</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        &amp;&amp; args.get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW) instanceof Integer) {</span>
<span class="fc" id="L187">      collectionMaximumNumber = (Integer) args</span>
<span class="fc" id="L188">          .get(CONFIG_COLLECTION_MAXIMUM_OVERFLOW);</span>
    }
<span class="fc" id="L190">    collectionCache = new MtasSolrCollectionCache(collectionCacheDirectory,</span>
<span class="fc" id="L191">        collectionLifetime, collectionMaximumNumber, collectionMaximumOverflow);</span>
<span class="fc" id="L192">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.apache.solr.handler.component.SearchComponent#getDescription()
   */
  @Override
  public String getDescription() {
<span class="nc" id="L201">    return &quot;Mtas&quot;;</span>
  }

  /**
   * Gets the collection cache.
   *
   * @return the collection cache
   */
  public MtasSolrCollectionCache getCollectionCache() {
<span class="fc" id="L210">    return collectionCache;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#prepare(org.apache.solr.
   * handler.component.ResponseBuilder)
   */
  @Override
  public void prepare(ResponseBuilder rb) throws IOException {
    //System.out
    //.println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
    //+ &quot; - &quot; + rb.req.getParams().getBool(&quot;isShard&quot;, false) + &quot; PREPARE &quot;
    //+ rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc bfc" id="L226" title="All 2 branches covered.">    if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="fc" id="L227">      mtasSolrResultMerge = new MtasSolrResultMerge();</span>
<span class="fc" id="L228">      ComponentFields mtasFields = new ComponentFields();</span>
      // get settings document
<span class="fc" id="L230">      if (rb.req.getParams()</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">          .getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L232">        searchDocument.prepare(rb, mtasFields);</span>
      }
      // get settings kwic
<span class="fc" id="L235">      if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC,</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L237">        searchKwic.prepare(rb, mtasFields);</span>
      }
      // get settings list
<span class="fc" id="L240">      if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST,</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L242">        searchList.prepare(rb, mtasFields);</span>
      }
      // get settings group
<span class="fc" id="L245">      if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP,</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L247">        searchGroup.prepare(rb, mtasFields);</span>
      }
      // get settings termvector
<span class="fc" id="L250">      if (rb.req.getParams()</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">          .getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L252">        searchTermvector.prepare(rb, mtasFields);</span>
      }
      // get settings prefix
<span class="fc" id="L255">      if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX,</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L257">        searchPrefix.prepare(rb, mtasFields);</span>
      }
      // get settings stats
<span class="fc" id="L260">      if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS,</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L262">        searchStats.prepare(rb, mtasFields);</span>
      }
      // get settings facet
<span class="fc" id="L265">      if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET,</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L267">        searchFacet.prepare(rb, mtasFields);</span>
      }
      // get settings collection
<span class="fc" id="L270">      if (rb.req.getParams()</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">          .getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L272">        searchCollection.prepare(rb, mtasFields);</span>
      }
<span class="fc" id="L274">      rb.req.getContext().put(ComponentFields.class, mtasFields);</span>
    }
<span class="fc" id="L276">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#process(org.apache.solr.
   * handler.component.ResponseBuilder)
   */
  @Override
  public void process(ResponseBuilder rb) throws IOException {
    // System.out
    // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
    // + &quot; - &quot; + rb.req.getParams().getBool(&quot;isShard&quot;, false) + &quot; PROCESS &quot;
    // + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L291">    ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">    if (mtasFields != null) {</span>
<span class="fc" id="L293">      DocSet docSet = rb.getResults().docSet;</span>
<span class="fc" id="L294">      DocList docList = rb.getResults().docList;</span>
<span class="pc bpc" id="L295" title="2 of 6 branches missed.">      if (mtasFields.doStats || mtasFields.doDocument || mtasFields.doKwic</span>
<span class="pc bpc" id="L296" title="2 of 6 branches missed.">          || mtasFields.doList || mtasFields.doGroup || mtasFields.doFacet</span>
<span class="fc bfc" id="L297" title="All 4 branches covered.">          || mtasFields.doCollection || mtasFields.doTermVector</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">          || mtasFields.doPrefix) {</span>
<span class="fc" id="L299">        SolrIndexSearcher searcher = rb.req.getSearcher();</span>
<span class="fc" id="L300">        ArrayList&lt;Integer&gt; docSetList = null;</span>
<span class="fc" id="L301">        ArrayList&lt;Integer&gt; docListList = null;</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (docSet != null) {</span>
<span class="fc" id="L303">          docSetList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L304">          Iterator&lt;Integer&gt; docSetIterator = docSet.iterator();</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">          while (docSetIterator.hasNext()) {</span>
<span class="fc" id="L306">            docSetList.add(docSetIterator.next());</span>
          }
<span class="fc" id="L308">          Collections.sort(docSetList);</span>
        }
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">        if (docList != null) {</span>
<span class="fc" id="L311">          docListList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L312">          Iterator&lt;Integer&gt; docListIterator = docList.iterator();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">          while (docListIterator.hasNext()) {</span>
<span class="fc" id="L314">            docListList.add(docListIterator.next());</span>
          }
<span class="fc" id="L316">          Collections.sort(docListList);</span>
        }
<span class="fc bfc" id="L318" title="All 2 branches covered.">        for (String field : mtasFields.list.keySet()) {</span>
          try {
<span class="fc" id="L320">            CodecUtil.collectField(field, searcher, searcher.getRawReader(),</span>
<span class="fc" id="L321">                docListList, docSetList, mtasFields.list.get(field));</span>
<span class="fc" id="L322">          } catch (IllegalAccessException | IllegalArgumentException</span>
<span class="nc" id="L323">              | InvocationTargetException e) {</span>
<span class="nc" id="L324">            log.error(e);</span>
<span class="nc" id="L325">            throw new IOException(e);</span>
          }
        }
<span class="fc bfc" id="L328" title="All 2 branches covered.">        for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc" id="L329">          CodecUtil.collectCollection(searcher.getRawReader(), docSetList,</span>
<span class="fc" id="L330">              collection);</span>
        }
<span class="fc" id="L332">        NamedList&lt;Object&gt; mtasResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        if (mtasFields.doDocument) {</span>
<span class="nc" id="L334">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasDocumentResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            for (ComponentDocument document : mtasFields.list</span>
<span class="nc" id="L337">                .get(field).documentList) {</span>
<span class="nc" id="L338">              mtasDocumentResponses.add(searchDocument.create(document, false));</span>
            }
          }
          // add to response
<span class="nc" id="L342">          mtasResponse.add(&quot;document&quot;, mtasDocumentResponses);</span>
        }
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">        if (mtasFields.doKwic) {</span>
<span class="nc" id="L345">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasKwicResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            for (ComponentKwic kwic : mtasFields.list.get(field).kwicList) {</span>
<span class="nc" id="L348">              mtasKwicResponses.add(searchKwic.create(kwic, false));</span>
            }
          }
          // add to response
<span class="nc" id="L352">          mtasResponse.add(&quot;kwic&quot;, mtasKwicResponses);</span>
        }
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        if (mtasFields.doFacet) {</span>
<span class="nc" id="L355">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasFacetResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            for (ComponentFacet facet : mtasFields.list.get(field).facetList) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">              if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="nc" id="L359">                mtasFacetResponses.add(searchFacet.create(facet, true));</span>
<span class="nc" id="L360">              } else {</span>
<span class="nc" id="L361">                mtasFacetResponses.add(searchFacet.create(facet, false));</span>
              }
            }
          }
          // add to response
<span class="nc" id="L366">          mtasResponse.add(&quot;facet&quot;, mtasFacetResponses);</span>
        }
<span class="fc bfc" id="L368" title="All 2 branches covered.">        if (mtasFields.doCollection) {</span>
<span class="fc" id="L369">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasCollectionResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">          for (ComponentCollection collection : mtasFields.collection) {</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">            if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L372">              mtasCollectionResponses</span>
<span class="fc" id="L373">                  .add(searchCollection.create(collection, true));</span>
<span class="fc" id="L374">            } else {</span>
<span class="fc" id="L375">              mtasCollectionResponses</span>
<span class="fc" id="L376">                  .add(searchCollection.create(collection, false));</span>
            }
          }
          // add to response
<span class="fc" id="L380">          mtasResponse.add(&quot;collection&quot;, mtasCollectionResponses);</span>
        }
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">        if (mtasFields.doList) {</span>
<span class="nc" id="L383">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasListResponses = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            for (ComponentList list : mtasFields.list.get(field).listList) {</span>
<span class="nc" id="L386">              mtasListResponses.add(searchList.create(list, false));</span>
            }
          }
          // add to response
<span class="nc" id="L390">          mtasResponse.add(&quot;list&quot;, mtasListResponses);</span>
        }
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (mtasFields.doGroup) {</span>
<span class="fc" id="L393">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasGroupResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">            for (ComponentGroup group : mtasFields.list.get(field).groupList) {</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">              if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="nc" id="L397">                mtasGroupResponses.add(searchGroup.create(group, true));</span>
<span class="nc" id="L398">              } else {</span>
<span class="fc" id="L399">                mtasGroupResponses.add(searchGroup.create(group, false));</span>
              }
            }
          }
          // add to response
<span class="fc" id="L404">          mtasResponse.add(&quot;group&quot;, mtasGroupResponses);</span>
        }
<span class="fc bfc" id="L406" title="All 2 branches covered.">        if (mtasFields.doTermVector) {</span>
<span class="fc" id="L407">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasTermVectorResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">            for (ComponentTermVector termVector : mtasFields.list</span>
<span class="fc" id="L410">                .get(field).termVectorList) {</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">              if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L412">                mtasTermVectorResponses</span>
<span class="fc" id="L413">                    .add(searchTermvector.create(termVector, true));</span>
<span class="fc" id="L414">              } else {</span>
<span class="fc" id="L415">                mtasTermVectorResponses</span>
<span class="fc" id="L416">                    .add(searchTermvector.create(termVector, false));</span>
              }
            }
          }
          // add to response
<span class="fc" id="L421">          mtasResponse.add(&quot;termvector&quot;, mtasTermVectorResponses);</span>
        }
<span class="fc bfc" id="L423" title="All 2 branches covered.">        if (mtasFields.doPrefix) {</span>
<span class="fc" id="L424">          ArrayList&lt;NamedList&lt;?&gt;&gt; mtasPrefixResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">          for (String field : mtasFields.list.keySet()) {</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">            if (mtasFields.list.get(field).prefix != null) {</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">              if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L428">                mtasPrefixResponses.add(searchPrefix</span>
<span class="fc" id="L429">                    .create(mtasFields.list.get(field).prefix, true));</span>
<span class="fc" id="L430">              } else {</span>
<span class="fc" id="L431">                mtasPrefixResponses.add(searchPrefix</span>
<span class="fc" id="L432">                    .create(mtasFields.list.get(field).prefix, false));</span>
              }
            }
          }
<span class="fc" id="L436">          mtasResponse.add(&quot;prefix&quot;, mtasPrefixResponses);</span>
        }
<span class="fc bfc" id="L438" title="All 2 branches covered.">        if (mtasFields.doStats) {</span>
<span class="fc" id="L439">          NamedList&lt;Object&gt; mtasStatsResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="fc bfc" id="L440" title="All 4 branches covered.">          if (mtasFields.doStatsPositions || mtasFields.doStatsTokens</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">              || mtasFields.doStatsSpans) {</span>
<span class="fc bfc" id="L442" title="All 2 branches covered.">            if (mtasFields.doStatsTokens) {</span>
<span class="fc" id="L443">              ArrayList&lt;Object&gt; mtasStatsTokensResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">              for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">                for (ComponentToken token : mtasFields.list</span>
<span class="fc" id="L446">                    .get(field).statsTokenList) {</span>
<span class="fc bfc" id="L447" title="All 2 branches covered.">                  if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L448">                    mtasStatsTokensResponses</span>
<span class="fc" id="L449">                        .add(searchStats.create(token, true));</span>
<span class="fc" id="L450">                  } else {</span>
<span class="fc" id="L451">                    mtasStatsTokensResponses</span>
<span class="fc" id="L452">                        .add(searchStats.create(token, false));</span>
                  }
                }
              }
<span class="fc" id="L456">              mtasStatsResponse.add(&quot;tokens&quot;, mtasStatsTokensResponses);</span>
            }
<span class="fc bfc" id="L458" title="All 2 branches covered.">            if (mtasFields.doStatsPositions) {</span>
<span class="fc" id="L459">              ArrayList&lt;Object&gt; mtasStatsPositionsResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">              for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">                for (ComponentPosition position : mtasFields.list</span>
<span class="fc" id="L462">                    .get(field).statsPositionList) {</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">                  if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L464">                    mtasStatsPositionsResponses</span>
<span class="fc" id="L465">                        .add(searchStats.create(position, true));</span>
<span class="fc" id="L466">                  } else {</span>
<span class="fc" id="L467">                    mtasStatsPositionsResponses</span>
<span class="fc" id="L468">                        .add(searchStats.create(position, false));</span>
                  }
                }
              }
<span class="fc" id="L472">              mtasStatsResponse.add(&quot;positions&quot;, mtasStatsPositionsResponses);</span>
            }
<span class="fc bfc" id="L474" title="All 2 branches covered.">            if (mtasFields.doStatsSpans) {</span>
<span class="fc" id="L475">              ArrayList&lt;Object&gt; mtasStatsSpansResponses = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">              for (String field : mtasFields.list.keySet()) {</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">                for (ComponentSpan span : mtasFields.list</span>
<span class="fc" id="L478">                    .get(field).statsSpanList) {</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">                  if (rb.req.getParams().getBool(&quot;isShard&quot;, false)) {</span>
<span class="fc" id="L480">                    mtasStatsSpansResponses.add(searchStats.create(span, true));</span>
<span class="fc" id="L481">                  } else {</span>
<span class="fc" id="L482">                    mtasStatsSpansResponses</span>
<span class="fc" id="L483">                        .add(searchStats.create(span, false));</span>
                  }
                }
              }
<span class="fc" id="L487">              mtasStatsResponse.add(&quot;spans&quot;, mtasStatsSpansResponses);</span>
            }
            // add to response
<span class="fc" id="L490">            mtasResponse.add(&quot;stats&quot;, mtasStatsResponse);</span>
          }
        }
        // add to response
<span class="fc" id="L494">        rb.rsp.add(&quot;mtas&quot;, mtasResponse);</span>
      }
    }
<span class="fc" id="L497">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#modifyRequest(org.apache.
   * solr.handler.component.ResponseBuilder,
   * org.apache.solr.handler.component.SearchComponent,
   * org.apache.solr.handler.component.ShardRequest)
   */
  @Override
  public void modifyRequest(ResponseBuilder rb, SearchComponent who,
      ShardRequest sreq) {
    // System.out.println(System.nanoTime() + &quot; - &quot; +
    // Thread.currentThread().getId() + &quot; - &quot;
    // + rb.req.getParams().getBool(&quot;isShard&quot;, false) + &quot; MODIFY REQUEST &quot;
    // + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc bfc" id="L515" title="All 2 branches covered.">    if (sreq.params.getBool(PARAM_MTAS, false)) {</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">      if (sreq.params.getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L517">        searchStats.modifyRequest(rb, who, sreq);</span>
      }
<span class="fc" id="L519">      if (sreq.params.getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR,</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L521">        searchTermvector.modifyRequest(rb, who, sreq);</span>
      }
<span class="fc" id="L523">      if (sreq.params.getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX,</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L525">        searchPrefix.modifyRequest(rb, who, sreq);</span>
      }
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">      if (sreq.params.getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L528">        searchFacet.modifyRequest(rb, who, sreq);</span>
      }
<span class="fc" id="L530">      if (sreq.params.getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION,</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L532">        searchCollection.modifyRequest(rb, who, sreq);</span>
      }
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">      if (sreq.params.getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L535">        searchGroup.modifyRequest(rb, who, sreq);</span>
      }
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">      if (sreq.params.getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L538">        searchList.modifyRequest(rb, who, sreq);</span>
      }
<span class="fc" id="L540">      if (sreq.params.getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT,</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L542">        searchDocument.modifyRequest(rb, who, sreq);</span>
      }
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">      if (sreq.params.getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC, false)) {</span>
<span class="nc" id="L545">        searchKwic.modifyRequest(rb, who, sreq);</span>
      }
    }
<span class="fc" id="L548">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see org.apache.solr.handler.component.SearchComponent#handleResponses(org.
   * apache.solr.handler.component.ResponseBuilder,
   * org.apache.solr.handler.component.ShardRequest)
   */
  @Override
  public void handleResponses(ResponseBuilder rb, ShardRequest sreq) {
    // System.out
    // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
    // + &quot; - &quot; + rb.req.getParams().getBool(&quot;isShard&quot;, false)
    // + &quot; HANDLERESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc" id="L563">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
   * apache.solr.handler.component.ResponseBuilder)
   */
  @Override
  public void finishStage(ResponseBuilder rb) {
    // System.out
    // .println(System.nanoTime() + &quot; - &quot; + Thread.currentThread().getId()
    // + &quot; - &quot; + rb.req.getParams().getBool(&quot;isShard&quot;, false)
    // + &quot; FINISHRESPONSES &quot; + rb.stage + &quot; &quot; + rb.req.getParamString());
<span class="fc bfc" id="L578" title="All 2 branches covered.">    if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="fc" id="L579">      if (rb.req.getParams().getBool(MtasSolrComponentStats.PARAM_MTAS_STATS,</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L581">        searchStats.finishStage(rb);</span>
      }
<span class="fc" id="L583">      if (rb.req.getParams()</span>
<span class="fc bfc" id="L584" title="All 2 branches covered.">          .getBool(MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L585">        searchTermvector.finishStage(rb);</span>
      }
<span class="fc" id="L587">      if (rb.req.getParams().getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX,</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">          false)) {</span>
<span class="fc" id="L589">        searchPrefix.finishStage(rb);</span>
      }
<span class="fc" id="L591">      if (rb.req.getParams().getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET,</span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L593">        searchFacet.finishStage(rb);</span>
      }
<span class="fc" id="L595">      if (rb.req.getParams()</span>
<span class="fc bfc" id="L596" title="All 2 branches covered.">          .getBool(MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L597">        searchCollection.finishStage(rb);</span>
      }
<span class="fc" id="L599">      if (rb.req.getParams().getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP,</span>
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L601">        searchGroup.finishStage(rb);</span>
      }
<span class="fc" id="L603">      if (rb.req.getParams().getBool(MtasSolrComponentList.PARAM_MTAS_LIST,</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L605">        searchList.finishStage(rb);</span>
      }
<span class="fc" id="L607">      if (rb.req.getParams()</span>
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">          .getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L609">        searchDocument.finishStage(rb);</span>
      }
<span class="fc" id="L611">      if (rb.req.getParams().getBool(MtasSolrComponentKwic.PARAM_MTAS_KWIC,</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">          false)) {</span>
<span class="nc" id="L613">        searchKwic.finishStage(rb);</span>
      }
<span class="fc" id="L615">      mtasSolrResultMerge.merge(rb);</span>
    }
<span class="fc" id="L617">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.solr.handler.component.SearchComponent#distributedProcess(org.
   * apache.solr.handler.component.ResponseBuilder)
   */
  @Override
  public int distributedProcess(ResponseBuilder rb) throws IOException {
    // System.out.println(System.nanoTime() + &quot; - &quot; +
    // Thread.currentThread().getId() + &quot; - &quot;
    // + rb.req.getParams().getBool(&quot;isShard&quot;, false) + &quot; DISTIRBUTEDPROCESS &quot;
    // + rb.stage + &quot; &quot; + rb.req.getParamString());
    // distributed processes
<span class="fc bfc" id="L633" title="All 2 branches covered.">    if (rb.req.getParams().getBool(PARAM_MTAS, false)) {</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">      if (rb.stage == STAGE_TERMVECTOR_MISSING_TOP</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">          || rb.stage == STAGE_TERMVECTOR_MISSING_KEY</span>
<span class="fc bfc" id="L636" title="All 2 branches covered.">          || rb.stage == STAGE_TERMVECTOR_FINISH) {</span>
<span class="fc" id="L637">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L638">        searchTermvector.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">      } else if (rb.stage == STAGE_LIST) {</span>
<span class="nc" id="L640">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L641">        searchList.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L642" title="All 2 branches covered.">      } else if (rb.stage == STAGE_PREFIX) {</span>
<span class="fc" id="L643">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L644">        searchPrefix.distributedProcess(rb, mtasFields);</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">      } else if (rb.stage == STAGE_STATS) {</span>
<span class="fc" id="L646">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L647">        searchStats.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">      } else if (rb.stage == STAGE_FACET) {</span>
<span class="nc" id="L649">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L650">        searchFacet.distributedProcess(rb, mtasFields);</span>
<span class="pc bfc" id="L651" title="All 2 branches covered.">      } else if (rb.stage == STAGE_COLLECTION_INIT</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">          || rb.stage == STAGE_COLLECTION_FINISH) {</span>
<span class="fc" id="L653">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="fc" id="L654">        searchCollection.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">      } else if (rb.stage == STAGE_GROUP) {</span>
<span class="nc" id="L656">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L657">        searchGroup.distributedProcess(rb, mtasFields);</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">      } else if (rb.stage == STAGE_DOCUMENT) {</span>
<span class="nc" id="L659">        ComponentFields mtasFields = getMtasFields(rb);</span>
<span class="nc" id="L660">        searchDocument.distributedProcess(rb, mtasFields);</span>
      }
      // compute new stage and return if not finished
<span class="fc bfc" id="L663" title="All 2 branches covered.">      if (rb.stage &gt;= ResponseBuilder.STAGE_EXECUTE_QUERY</span>
<span class="fc bfc" id="L664" title="All 2 branches covered.">          &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="fc bfc" id="L665" title="All 2 branches covered.">        if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_TOP</span>
<span class="fc" id="L666">            &amp;&amp; rb.req.getParams().getBool(</span>
<span class="fc bfc" id="L667" title="All 2 branches covered.">                MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L668">          return STAGE_TERMVECTOR_MISSING_TOP;</span>
<span class="fc bfc" id="L669" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_TERMVECTOR_MISSING_KEY</span>
<span class="fc" id="L670">            &amp;&amp; rb.req.getParams().getBool(</span>
<span class="fc bfc" id="L671" title="All 2 branches covered.">                MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L672">          return STAGE_TERMVECTOR_MISSING_KEY;</span>
<span class="fc bfc" id="L673" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_TERMVECTOR_FINISH</span>
<span class="fc" id="L674">            &amp;&amp; rb.req.getParams().getBool(</span>
<span class="fc bfc" id="L675" title="All 2 branches covered.">                MtasSolrComponentTermvector.PARAM_MTAS_TERMVECTOR, false)) {</span>
<span class="fc" id="L676">          return STAGE_TERMVECTOR_FINISH;</span>
<span class="fc bfc" id="L677" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_LIST &amp;&amp; rb.req.getParams()</span>
<span class="pc bpc" id="L678" title="1 of 2 branches missed.">            .getBool(MtasSolrComponentList.PARAM_MTAS_LIST, false)) {</span>
<span class="nc" id="L679">          return STAGE_LIST;</span>
<span class="fc bfc" id="L680" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_PREFIX &amp;&amp; rb.req.getParams()</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">            .getBool(MtasSolrComponentPrefix.PARAM_MTAS_PREFIX, false)) {</span>
<span class="fc" id="L682">          return STAGE_PREFIX;</span>
<span class="fc bfc" id="L683" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_STATS &amp;&amp; rb.req.getParams()</span>
<span class="fc bfc" id="L684" title="All 2 branches covered.">            .getBool(MtasSolrComponentStats.PARAM_MTAS_STATS, false)) {</span>
<span class="fc" id="L685">          return STAGE_STATS;</span>
<span class="fc bfc" id="L686" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_FACET &amp;&amp; rb.req.getParams()</span>
<span class="pc bpc" id="L687" title="1 of 2 branches missed.">            .getBool(MtasSolrComponentFacet.PARAM_MTAS_FACET, false)) {</span>
<span class="nc" id="L688">          return STAGE_FACET;</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_GROUP &amp;&amp; rb.req.getParams()</span>
<span class="pc bpc" id="L690" title="1 of 2 branches missed.">            .getBool(MtasSolrComponentGroup.PARAM_MTAS_GROUP, false)) {</span>
<span class="nc" id="L691">          return STAGE_GROUP;</span>
<span class="fc bfc" id="L692" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_COLLECTION_INIT</span>
<span class="fc" id="L693">            &amp;&amp; rb.req.getParams().getBool(</span>
<span class="fc bfc" id="L694" title="All 2 branches covered.">                MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L695">          return STAGE_COLLECTION_INIT;</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">        } else if (rb.stage &lt; STAGE_COLLECTION_FINISH</span>
<span class="fc" id="L697">            &amp;&amp; rb.req.getParams().getBool(</span>
<span class="fc bfc" id="L698" title="All 2 branches covered.">                MtasSolrComponentCollection.PARAM_MTAS_COLLECTION, false)) {</span>
<span class="fc" id="L699">          return STAGE_COLLECTION_FINISH;</span>
        }
<span class="fc bfc" id="L701" title="All 2 branches covered.">      } else if (rb.stage &gt;= ResponseBuilder.STAGE_GET_FIELDS</span>
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">          &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_DONE) {</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">        if (rb.stage &lt; STAGE_DOCUMENT &amp;&amp; rb.req.getParams()</span>
<span class="pc bpc" id="L704" title="1 of 2 branches missed.">            .getBool(MtasSolrComponentDocument.PARAM_MTAS_DOCUMENT, false)) {</span>
<span class="nc" id="L705">          return STAGE_DOCUMENT;</span>
        }
      }
    }
<span class="fc" id="L709">    return ResponseBuilder.STAGE_DONE;</span>
  }

  /**
   * Gets the mtas fields.
   *
   * @param rb the rb
   * @return the mtas fields
   */

  private ComponentFields getMtasFields(ResponseBuilder rb) {
<span class="fc" id="L720">    return (ComponentFields) rb.req.getContext().get(ComponentFields.class);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>