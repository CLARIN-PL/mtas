<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MtasCodecPostingsFormat.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.codec</a> &gt; <span class="el_source">MtasCodecPostingsFormat.java</span></div><h1>MtasCodecPostingsFormat.java</h1><pre class="source lang-java linenums">package mtas.codec;

import java.io.IOException;
import mtas.analysis.token.MtasTokenString;
import org.apache.lucene.codecs.Codec;
import org.apache.lucene.codecs.FieldsConsumer;
import org.apache.lucene.codecs.FieldsProducer;
import org.apache.lucene.codecs.PostingsFormat;
import org.apache.lucene.index.SegmentReadState;
import org.apache.lucene.index.SegmentWriteState;
import org.apache.lucene.store.IndexInput;
import org.apache.lucene.util.BytesRef;

/**
 * The Class MtasCodecPostingsFormat.
 */
public class MtasCodecPostingsFormat extends PostingsFormat {

  /** The Constant VERSION_START. */
  public static final int VERSION_START = 3;

  /** The Constant VERSION_CURRENT. */
  public static final int VERSION_CURRENT = 3;

  /** The Constant MTAS_OBJECT_HAS_PARENT. */
  static final int MTAS_OBJECT_HAS_PARENT = 1;

  /** The Constant MTAS_OBJECT_HAS_POSITION_RANGE. */
  static final int MTAS_OBJECT_HAS_POSITION_RANGE = 2;

  /** The Constant MTAS_OBJECT_HAS_POSITION_SET. */
  static final int MTAS_OBJECT_HAS_POSITION_SET = 4;

  /** The Constant MTAS_OBJECT_HAS_OFFSET. */
  static final int MTAS_OBJECT_HAS_OFFSET = 8;

  /** The Constant MTAS_OBJECT_HAS_REALOFFSET. */
  static final int MTAS_OBJECT_HAS_REALOFFSET = 16;

  /** The Constant MTAS_OBJECT_HAS_PAYLOAD. */
  static final int MTAS_OBJECT_HAS_PAYLOAD = 32;

  /** The Constant MTAS_STORAGE_BYTE. */
  public static final int MTAS_STORAGE_BYTE = 0;

  /** The Constant MTAS_STORAGE_SHORT. */
  public static final int MTAS_STORAGE_SHORT = 1;

  /** The Constant MTAS_STORAGE_INTEGER. */
  public static final int MTAS_STORAGE_INTEGER = 2;

  /** The Constant MTAS_STORAGE_LONG. */
  public static final int MTAS_STORAGE_LONG = 3;

  /** The Constant MTAS_TMP_FIELD_EXTENSION. */
  public static final String MTAS_TMP_FIELD_EXTENSION = &quot;mtas.field.temporary&quot;;

  /** The Constant MTAS_TMP_OBJECT_EXTENSION. */
  public static final String MTAS_TMP_OBJECT_EXTENSION = &quot;mtas.object.temporary&quot;;

  /** The Constant MTAS_TMP_DOCS_EXTENSION. */
  public static final String MTAS_TMP_DOCS_EXTENSION = &quot;mtas.docs.temporary&quot;;

  /** The Constant MTAS_TMP_DOC_EXTENSION. */
  public static final String MTAS_TMP_DOC_EXTENSION = &quot;mtas.doc.temporary&quot;;

  /** The Constant MTAS_TMP_DOCS_CHAINED_EXTENSION. */
  public static final String MTAS_TMP_DOCS_CHAINED_EXTENSION = &quot;mtas.docs.chained.temporary&quot;;

  /** The Constant MTAS_FIELDINFO_ATTRIBUTE_PREFIX_SINGLE_POSITION. */
  public static final String MTAS_FIELDINFO_ATTRIBUTE_PREFIX_SINGLE_POSITION = &quot;mtas.prefix.single.position&quot;;

  /** The Constant MTAS_FIELDINFO_ATTRIBUTE_PREFIX_MULTIPLE_POSITION. */
  public static final String MTAS_FIELDINFO_ATTRIBUTE_PREFIX_MULTIPLE_POSITION = &quot;mtas.prefix.multiple.position&quot;;

  /** The Constant MTAS_FIELDINFO_ATTRIBUTE_PREFIX_SET_POSITION. */
  public static final String MTAS_FIELDINFO_ATTRIBUTE_PREFIX_SET_POSITION = &quot;mtas.prefix.set.position&quot;;

  /** The Constant MTAS_FIELDINFO_ATTRIBUTE_PREFIX_INTERSECTION. */
  public static final String MTAS_FIELDINFO_ATTRIBUTE_PREFIX_INTERSECTION = &quot;mtas.prefix.intersection&quot;;

  /** The Constant MTAS_OBJECT_EXTENSION. */
  public static final String MTAS_OBJECT_EXTENSION = &quot;mtas.object&quot;;

  /** The Constant MTAS_TERM_EXTENSION. */
  public static final String MTAS_TERM_EXTENSION = &quot;mtas.term&quot;;

  /** The Constant MTAS_FIELD_EXTENSION. */
  public static final String MTAS_FIELD_EXTENSION = &quot;mtas.field&quot;;

  /** The Constant MTAS_PREFIX_EXTENSION. */
  public static final String MTAS_PREFIX_EXTENSION = &quot;mtas.prefix&quot;;

  /** The Constant MTAS_DOC_EXTENSION. */
  public static final String MTAS_DOC_EXTENSION = &quot;mtas.doc&quot;;

  /** The Constant MTAS_INDEX_DOC_ID_EXTENSION. */
  public static final String MTAS_INDEX_DOC_ID_EXTENSION = &quot;mtas.index.doc.id&quot;;

  /** The Constant MTAS_INDEX_OBJECT_ID_EXTENSION. */
  public static final String MTAS_INDEX_OBJECT_ID_EXTENSION = &quot;mtas.index.object.id&quot;;

  /** The Constant MTAS_INDEX_OBJECT_POSITION_EXTENSION. */
  public static final String MTAS_INDEX_OBJECT_POSITION_EXTENSION = &quot;mtas.index.object.position&quot;;

  /** The Constant MTAS_INDEX_OBJECT_PARENT_EXTENSION. */
  public static final String MTAS_INDEX_OBJECT_PARENT_EXTENSION = &quot;mtas.index.object.parent&quot;;

  /** The Constant MTAS_INDEX_TERM_PREFIX_POSITION_EXTENSION. */
  public static final String MTAS_INDEX_TERM_PREFIX_POSITION_EXTENSION = &quot;mtas.index.term.prefix.position&quot;;

  /** The delegate codec name. */
<span class="fc" id="L113">  private String delegateCodecName = null;</span>

  /** The delegate postings format. */
<span class="fc" id="L116">  private PostingsFormat delegatePostingsFormat = null;</span>

  /**
   * Instantiates a new mtas codec postings format.
   */
  public MtasCodecPostingsFormat() {
<span class="fc" id="L122">    this(MtasCodec.MTAS_CODEC_NAME);</span>
<span class="fc" id="L123">  }</span>

  /**
   * Instantiates a new mtas codec postings format.
   *
   * @param delegate the delegate
   */
  public MtasCodecPostingsFormat(PostingsFormat delegate) {
<span class="fc" id="L131">    super(MtasCodec.MTAS_CODEC_NAME);</span>
<span class="fc" id="L132">    delegateCodecName = delegate.getName();</span>
<span class="fc" id="L133">    delegatePostingsFormat = delegate;</span>
    // preload to prevent NoClassDefFoundErrors
    try {
<span class="fc" id="L136">      Class.forName(&quot;mtas.codec.payload.MtasPayloadDecoder&quot;);</span>
<span class="fc" id="L137">      Class.forName(&quot;mtas.codec.payload.MtasBitInputStream&quot;);</span>
<span class="fc" id="L138">      Class.forName(&quot;mtas.analysis.token.MtasPosition&quot;);</span>
<span class="fc" id="L139">      Class.forName(&quot;mtas.analysis.token.MtasOffset&quot;);</span>
<span class="fc" id="L140">      Class.forName(&quot;mtas.codec.tree.MtasRBTree&quot;);</span>
<span class="fc" id="L141">      Class.forName(&quot;mtas.codec.MtasTerms&quot;);</span>
<span class="fc" id="L142">      Class.forName(&quot;mtas.codec.util.CodecInfo&quot;);</span>
<span class="fc" id="L143">      Class.forName(&quot;mtas.codec.tree.MtasTreeNodeId&quot;);</span>
<span class="nc" id="L144">    } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L145">      e.printStackTrace();</span>
<span class="fc" id="L146">    }</span>
<span class="fc" id="L147">  }</span>

  /**
   * Instantiates a new mtas codec postings format.
   *
   * @param codecName the codec name
   */
  public MtasCodecPostingsFormat(String codecName) {
<span class="fc" id="L155">    super(codecName);</span>
<span class="fc" id="L156">    delegateCodecName = codecName;</span>
<span class="fc" id="L157">    delegatePostingsFormat = null;</span>
    // preload to prevent NoClassDefFoundErrors
    try {
<span class="fc" id="L160">      Class.forName(&quot;mtas.codec.payload.MtasPayloadDecoder&quot;);</span>
<span class="fc" id="L161">      Class.forName(&quot;mtas.codec.payload.MtasBitInputStream&quot;);</span>
<span class="fc" id="L162">      Class.forName(&quot;mtas.analysis.token.MtasPosition&quot;);</span>
<span class="fc" id="L163">      Class.forName(&quot;mtas.analysis.token.MtasOffset&quot;);</span>
<span class="fc" id="L164">      Class.forName(&quot;mtas.codec.tree.MtasRBTree&quot;);</span>
<span class="fc" id="L165">      Class.forName(&quot;mtas.codec.MtasTerms&quot;);</span>
<span class="fc" id="L166">      Class.forName(&quot;mtas.codec.util.CodecInfo&quot;);</span>
<span class="fc" id="L167">      Class.forName(&quot;mtas.codec.tree.MtasTreeNodeId&quot;);</span>
<span class="nc" id="L168">    } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L169">      e.printStackTrace();</span>
<span class="fc" id="L170">    }</span>
<span class="fc" id="L171">  }</span>

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.lucene.codecs.PostingsFormat#fieldsProducer(org.apache.lucene
   * .index.SegmentReadState)
   */
  @Override
  public final FieldsProducer fieldsProducer(SegmentReadState state)
      throws IOException {
<span class="fc" id="L183">    return new MtasFieldsProducer(state, getName());</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see
   * org.apache.lucene.codecs.PostingsFormat#fieldsConsumer(org.apache.lucene
   * .index.SegmentWriteState)
   */
  @Override
  public final FieldsConsumer fieldsConsumer(SegmentWriteState state)
      throws IOException {
<span class="fc bfc" id="L196" title="All 2 branches covered.">    if (delegatePostingsFormat != null) {</span>
<span class="fc" id="L197">      return new MtasFieldsConsumer(</span>
<span class="fc" id="L198">          delegatePostingsFormat.fieldsConsumer(state), state, getName(),</span>
<span class="fc" id="L199">          delegatePostingsFormat.getName());</span>
    } else {
<span class="fc" id="L201">      PostingsFormat pf = Codec.forName(delegateCodecName).postingsFormat();</span>
<span class="fc" id="L202">      return pf.fieldsConsumer(state);</span>
    }
  }

  /**
   * Gets the token.
   *
   * @param inObject the in object
   * @param inTerm the in term
   * @param ref the ref
   * @return the token
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public static MtasTokenString getToken(IndexInput inObject,
      IndexInput inTerm, Long ref) throws IOException {
<span class="fc" id="L217">    MtasTokenString token = null;</span>
    try {
<span class="fc" id="L219">      inObject.seek(ref);</span>
<span class="fc" id="L220">      token = new MtasTokenString(null, &quot;&quot;);</span>
<span class="fc" id="L221">      token.setId(inObject.readVInt());</span>
<span class="fc" id="L222">      token.setTokenRef(ref);</span>
<span class="fc" id="L223">      int objectFlags = inObject.readVInt();</span>
<span class="fc" id="L224">      int[] positions = null;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">      if ((objectFlags &amp; MTAS_OBJECT_HAS_PARENT) == MTAS_OBJECT_HAS_PARENT) {</span>
<span class="fc" id="L226">        int parentId = inObject.readVInt();</span>
<span class="fc" id="L227">        token.setParentId(parentId);</span>
      }
<span class="fc bfc" id="L229" title="All 2 branches covered.">      if ((objectFlags</span>
          &amp; MTAS_OBJECT_HAS_POSITION_RANGE) == MTAS_OBJECT_HAS_POSITION_RANGE) {
<span class="fc" id="L231">        int positionStart = inObject.readVInt();</span>
<span class="fc" id="L232">        int positionEnd = positionStart + inObject.readVInt();</span>
<span class="fc" id="L233">        token.addPositionRange(positionStart, positionEnd);</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">      } else if ((objectFlags</span>
          &amp; MTAS_OBJECT_HAS_POSITION_SET) == MTAS_OBJECT_HAS_POSITION_SET) {
<span class="fc" id="L236">        int size = inObject.readVInt();</span>
<span class="fc" id="L237">        int tmpPrevious = 0;</span>
<span class="fc" id="L238">        positions = new int[size];</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">        for (int t = 0; t &lt; size; t++) {</span>
<span class="fc" id="L240">          int position = tmpPrevious + inObject.readVInt();</span>
<span class="fc" id="L241">          tmpPrevious = position;</span>
<span class="fc" id="L242">          positions[t] = position;</span>
        }
<span class="fc" id="L244">        token.addPositions(positions);</span>
<span class="fc" id="L245">      } else {</span>
<span class="fc" id="L246">        int position = inObject.readVInt();</span>
<span class="fc" id="L247">        token.addPosition(position);</span>
      }
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">      if ((objectFlags &amp; MTAS_OBJECT_HAS_OFFSET) == MTAS_OBJECT_HAS_OFFSET) {</span>
<span class="nc" id="L250">        int offsetStart = inObject.readVInt();</span>
<span class="nc" id="L251">        int offsetEnd = offsetStart + inObject.readVInt();</span>
<span class="nc" id="L252">        token.setOffset(offsetStart, offsetEnd);</span>
      }
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">      if ((objectFlags</span>
          &amp; MTAS_OBJECT_HAS_REALOFFSET) == MTAS_OBJECT_HAS_REALOFFSET) {
<span class="nc" id="L256">        int realOffsetStart = inObject.readVInt();</span>
<span class="nc" id="L257">        int realOffsetEnd = realOffsetStart + inObject.readVInt();</span>
<span class="nc" id="L258">        token.setRealOffset(realOffsetStart, realOffsetEnd);</span>
      }
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">      if ((objectFlags &amp; MTAS_OBJECT_HAS_PAYLOAD) == MTAS_OBJECT_HAS_PAYLOAD) {</span>
<span class="nc" id="L261">        int length = inObject.readVInt();</span>
<span class="nc" id="L262">        byte[] mtasPayload = new byte[length];</span>
<span class="nc" id="L263">        inObject.readBytes(mtasPayload, 0, length);</span>
<span class="nc" id="L264">        token.setPayload(new BytesRef(mtasPayload));</span>
      }
<span class="fc" id="L266">      Long termRef = inObject.readVLong();</span>
<span class="fc" id="L267">      inTerm.seek(termRef);</span>
<span class="fc" id="L268">      token.setTermRef(termRef);</span>
<span class="fc" id="L269">      token.setValue(inTerm.readString());</span>
<span class="nc" id="L270">    } catch (Exception e) {</span>
<span class="nc" id="L271">      throw new IOException(e.getMessage());</span>
<span class="fc" id="L272">    }</span>
<span class="fc" id="L273">    return token;</span>
  }

  /**
   * Gets the term.
   *
   * @param inTerm the in term
   * @param ref the ref
   * @return the term
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public static String getTerm(IndexInput inTerm, Long ref) throws IOException {
    try {
<span class="fc" id="L286">      inTerm.seek(ref);</span>
<span class="fc" id="L287">      return inTerm.readString();</span>
<span class="nc" id="L288">    } catch (Exception e) {</span>
<span class="nc" id="L289">      throw new IOException(e.getMessage());</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>