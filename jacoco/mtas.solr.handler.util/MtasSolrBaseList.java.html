<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasSolrBaseList.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.solr.handler.util</a> &gt; <span class="el_source">MtasSolrBaseList.java</span></div><h1>MtasSolrBaseList.java</h1><pre class="source lang-java linenums">package mtas.solr.handler.util;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

import org.apache.solr.common.util.SimpleOrderedMap;

/**
 * The Class MtasSolrBaseList.
 */
public abstract class MtasSolrBaseList {

  /** The list. */
  protected List&lt;MtasSolrStatus&gt; list;

  /** The index. */
  protected Map&lt;String, MtasSolrStatus&gt; index;

  /** The enabled. */
<span class="fc" id="L26">  private boolean enabled = true;</span>

  /** The Constant NAME_ENABLED. */
  private final static String NAME_ENABLED = &quot;enabled&quot;;

  /** The Constant NAME_LIST. */
  private final static String NAME_LIST = &quot;list&quot;;

  /** The Constant NAME_SIZE_TOTAL. */
  private final static String NAME_SIZE_TOTAL = &quot;sizeTotal&quot;;

  /** The Constant NAME_SIZE_NORMAL. */
  private final static String NAME_SIZE_NORMAL = &quot;sizeNormal&quot;;

  /** The Constant NAME_SIZE_SHARDREQUESTS. */
  private final static String NAME_SIZE_SHARDREQUESTS = &quot;sizeShardRequests&quot;;

  /**
   * Instantiates a new mtas solr base list.
   */
<span class="fc" id="L46">  public MtasSolrBaseList() {</span>
<span class="fc" id="L47">    list = Collections.synchronizedList(new ArrayList&lt;MtasSolrStatus&gt;());</span>
<span class="fc" id="L48">    index = Collections.synchronizedMap(new HashMap&lt;&gt;());</span>
<span class="fc" id="L49">  }</span>

  /**
   * Gets the.
   *
   * @param key the key
   * @return the mtas solr status
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public final MtasSolrStatus get(String key) throws IOException {
<span class="nc" id="L59">    return index.get(Objects.requireNonNull(key, &quot;no key provided&quot;));</span>
  }

  /**
   * Adds the.
   *
   * @param status the status
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public void add(MtasSolrStatus status) throws IOException {
<span class="fc" id="L69">    Objects.requireNonNull(status);</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">    if (enabled) {</span>
<span class="fc" id="L71">      list.add(status);</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">      if (!index.containsKey(status.key())) {</span>
<span class="fc" id="L73">        index.put(status.key(), status);</span>
<span class="fc" id="L74">        garbageCollect();</span>
      } else {
<span class="nc" id="L76">        garbageCollect();</span>
        // retry
<span class="nc" id="L78">        MtasSolrStatus oldStatus = index.get(status.key());</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (oldStatus == null) {</span>
<span class="nc" id="L80">          index.put(status.key(), status);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        } else if(oldStatus.finished()) {</span>
<span class="nc" id="L82">          remove(oldStatus);</span>
<span class="nc" id="L83">          index.put(status.key(), status);</span>
        } else {
<span class="nc" id="L85">          throw new IOException(&quot;key &quot; + status.key() + &quot; already exists&quot;);</span>
        }
      }
    }
<span class="fc" id="L89">  }</span>

  /**
   * Removes the.
   *
   * @param status the status
   */
  public final void remove(MtasSolrStatus status) {
<span class="fc" id="L97">    Objects.requireNonNull(status);</span>
<span class="fc" id="L98">    list.remove(status);</span>
<span class="fc" id="L99">    index.remove(status.key());</span>
<span class="fc" id="L100">  }</span>

  /**
   * Garbage collect.
   */
  public abstract void garbageCollect();

  /**
   * Reset.
   */
  public final void reset() {
<span class="nc" id="L111">    list.clear();</span>
<span class="nc" id="L112">    index.clear();</span>
<span class="nc" id="L113">  }</span>

  /**
   * Update key.
   *
   * @param key the key
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public final void updateKey(String key) throws IOException {
<span class="nc" id="L122">    Objects.requireNonNull(key, &quot;old key required&quot;);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (index.containsKey(key)) {</span>
<span class="nc" id="L124">      MtasSolrStatus status = index.get(key);</span>
<span class="nc" id="L125">      index.remove(key);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">      if (!index.containsKey(status.key())) {</span>
<span class="nc" id="L127">        index.put(status.key(), status);</span>
      } else {
<span class="nc" id="L129">        throw new IOException(&quot;key already exists&quot;);</span>
      }
    }
<span class="nc" id="L132">  }</span>

  /**
   * Sets the enabled.
   *
   * @param flag the new enabled
   */
  public final void setEnabled(boolean flag) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">    if (enabled != flag) {</span>
<span class="nc" id="L141">      reset();</span>
<span class="nc" id="L142">      enabled = flag;</span>
    }
<span class="nc" id="L144">  }</span>

  /**
   * Enabled.
   *
   * @return true, if successful
   */
  public final boolean enabled() {
<span class="nc" id="L152">    return enabled;</span>
  }

  /**
   * Creates the list output.
   *
   * @param shardRequests the shard requests
   * @return the simple ordered map
   */
  public SimpleOrderedMap&lt;Object&gt; createListOutput(boolean shardRequests) {
<span class="nc" id="L162">    garbageCollect();</span>
<span class="nc" id="L163">    SimpleOrderedMap&lt;Object&gt; output = new SimpleOrderedMap&lt;&gt;();</span>
<span class="nc" id="L164">    output.add(NAME_ENABLED, enabled());</span>
<span class="nc" id="L165">    output.add(NAME_ENABLED, true);</span>
<span class="nc" id="L166">    int numberTotal = list.size();</span>
<span class="nc" id="L167">    ListData listData = new ListData();</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">    if (numberTotal &gt; 0) {</span>
      // create list
<span class="nc" id="L170">      list.stream()</span>
<span class="nc" id="L171">          .collect(Collectors.collectingAndThen(Collectors.toList(), lst -&gt; {</span>
<span class="nc" id="L172">            Collections.reverse(lst);</span>
<span class="nc" id="L173">            return lst.stream();</span>
<span class="nc" id="L174">          })).forEach((item) -&gt; {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (item.shardRequest()) {</span>
<span class="nc" id="L176">              listData.addShardRequest();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">              if (shardRequests) {</span>
<span class="nc" id="L178">                listData.outputList.add(item.createItemOutput());</span>
              }
            } else {
<span class="nc" id="L181">              listData.addNormal();</span>
<span class="nc" id="L182">              listData.outputList.add(item.createItemOutput());</span>
            }
<span class="nc" id="L184">          });</span>
    }
<span class="nc" id="L186">    output.add(NAME_SIZE_TOTAL, numberTotal);</span>
<span class="nc" id="L187">    output.add(NAME_SIZE_NORMAL, listData.numberNormal);</span>
<span class="nc" id="L188">    output.add(NAME_SIZE_SHARDREQUESTS, listData.numberShardRequests);</span>
<span class="nc" id="L189">    output.add(NAME_LIST, listData.outputList);</span>
<span class="nc" id="L190">    return output;</span>
  }

  /**
   * The Class ListData.
   */
  static class ListData {
    
    /** The output list. */
    private List&lt;SimpleOrderedMap&lt;Object&gt;&gt; outputList;
    
    /** The number normal. */
    private int numberNormal;
    
    /** The number shard requests. */
    private int numberShardRequests;

    /**
     * Instantiates a new list data.
     */
<span class="nc" id="L210">    public ListData() {</span>
<span class="nc" id="L211">      outputList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L212">      numberNormal = 0;</span>
<span class="nc" id="L213">      numberShardRequests = 0;</span>
<span class="nc" id="L214">    }</span>

    /**
     * Adds the normal.
     */
    public void addNormal() {
<span class="nc" id="L220">      numberNormal++;</span>
<span class="nc" id="L221">    }</span>

    /**
     * Adds the shard request.
     */
    public void addShardRequest() {
<span class="nc" id="L227">      numberShardRequests++;</span>
<span class="nc" id="L228">    }</span>

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>